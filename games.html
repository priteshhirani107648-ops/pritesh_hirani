<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulators | Pritesh Hirani</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÆ</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Space+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">

    <style>
        /* ================= MASTER OVERFLOW FIX ================= */
        *, *::before, *::after { box-sizing: border-box; }

        /* ================= SHARED UI STYLES ================= */
        .games-header { text-align: center; padding: 180px 10% 60px; transition: 0.3s; }
        .game-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; padding: 0 5% 100px; max-width: 1200px; margin: 0 auto; }
        
        .card { position: relative; display: flex; flex-direction: column; justify-content: space-between; height: 100%; }
        .card i, .card h3, .card p { pointer-events: none; } 
        .card .btn { position: relative; z-index: 10; pointer-events: all; width: 100%; margin-top: auto; }

        .module-container { display: none; padding: 0 5% 100px; width: 100%; max-width: 1000px; margin: 0 auto; animation: slideUp 0.6s cubic-bezier(0.23, 1, 0.32, 1); }
        .quiz-hud { background: rgba(15, 23, 42, 0.95); border: 2px solid var(--accent-1); border-radius: 24px; padding: 30px; position: relative; backdrop-filter: blur(20px); box-shadow: 0 0 40px rgba(0, 240, 255, 0.15); width: 100%; overflow: hidden; }
        .hud-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid rgba(0, 240, 255, 0.2); padding-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .stop-btn { background: transparent; border: 1px solid var(--accent-3); color: var(--accent-3); padding: 8px 15px; border-radius: 8px; font-family: 'Space Mono'; font-size: 0.8rem; transition: 0.3s; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
        .stop-btn:hover { background: rgba(255, 0, 127, 0.1); box-shadow: 0 0 15px var(--accent-3); }
        .quiz-action-btns { display: flex; gap: 15px; margin-top: 30px; width: 100%; }
        .quiz-action-btns .btn { flex: 1; margin: 0; }

        /* ================= ECO SCHEMATIC STYLES ================= */
        .eco-stats { display: flex; gap: 10px; font-family: 'Space Mono'; flex-wrap: wrap; width: 100%; }
        .eco-stat-box { background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); flex: 1; text-align: center; min-width: 100px; font-size: 0.85rem; }
        .eco-slack-alert { animation: pulseRed 1.5s infinite; color: var(--accent-3) !important; font-weight: bold; }
        .eco-schematic { display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: flex-start; align-items: center; background: rgba(0, 240, 255, 0.02); border: 1px dashed rgba(0,240,255,0.2); border-radius: 15px; padding: 20px; margin: 15px 0; overflow-x: auto; gap: 5px; }
        .eco-flop { background: rgba(255,255,255,0.1); border: 2px solid white; color: white; padding: 15px 10px; border-radius: 8px; font-family: 'Space Mono'; font-weight: bold; font-size: 0.8rem; text-align: center; flex-shrink: 0; }
        .eco-node-wrapper { display: flex; flex-direction: row; align-items: center; flex-shrink: 0; position: relative; }
        .eco-wire { width: 40px; height: 6px; background: rgba(0,240,255,0.4); cursor: pointer; display: flex; justify-content: space-evenly; align-items: center; border-radius: 3px; }
        .eco-buffer { background: var(--accent-2); width: 16px; height: 16px; border-radius: 50%; border: 1px solid white; box-shadow: 0 0 10px var(--accent-2); position: relative; z-index: 5; cursor: pointer; }
        .eco-gate { background: rgba(15, 23, 42, 0.9); border: 2px solid var(--accent-1); padding: 10px 5px; border-radius: 12px; font-family: 'Space Mono'; text-align: center; width: 90px; cursor: pointer; transition: 0.3s; flex-shrink: 0; }
        .eco-gate.active { border-color: var(--accent-2); box-shadow: 0 0 25px var(--accent-2); background: rgba(255,0,127,0.1); transform: translateY(-5px); }
        .gate-title { font-size: 0.8rem; font-weight: bold; color: white; margin-bottom: 5px; }
        .gate-specs { font-size: 0.65rem; color: var(--accent-1); display: flex; flex-direction: column; gap: 2px; }
        .eco-inspector { background: rgba(0,0,0,0.8); border: 1px solid var(--accent-2); border-radius: 15px; padding: 15px; margin-top: 15px; display: none; }
        .eco-inspector.visible { display: block; }
        .insp-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        .insp-btn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 6px 10px; border-radius: 6px; font-family: 'Space Mono'; font-size: 0.75rem; cursor: pointer; }
        .insp-btn.active { background: var(--accent-2); border-color: white; font-weight: bold; }

        /* ================= LITHOGRAPHY GAME CSS ================= */
        .litho-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 240px; margin: 20px auto; }
        .litho-cell { aspect-ratio: 1; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; transition: 0.3s; }
        .litho-cell.active { background: var(--accent-1); box-shadow: 0 0 15px var(--accent-1); }
        .litho-controls { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .litho-mask-btn { width: 50px; height: 50px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.3); cursor: pointer; transition: 0.2s; }
        .litho-mask-btn.active { border-color: white; transform: scale(1.1); box-shadow: 0 0 15px currentColor; }

        /* ================= ROUTING & FLOORPLAN ================= */
        .routing-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; background: rgba(0, 240, 255, 0.05); border: 2px solid var(--accent-1); padding: 8px; border-radius: 12px; width: 100%; max-width: 350px; aspect-ratio: 1; margin: 0 auto; }
        .route-cell { background: rgba(0,0,0,0.6); border: 1px solid rgba(0, 240, 255, 0.2); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-family: 'Space Mono'; font-size: 1rem; color: white; cursor: pointer; }
        .route-cell.start { background: var(--accent-2); }
        .route-cell.end { background: #2ecc71; }
        .route-cell.obstacle { background: var(--accent-3); cursor: not-allowed; }
        .route-cell.path { background: var(--accent-1); }
        #chip-core { width: 100%; max-width: 400px; height: 400px; border: 2px solid var(--accent-1); position: relative; background: #000; overflow: hidden; margin: 0 auto; }
        .macro { background: var(--accent-2); border: 1px solid #fff; color: white; font-family: 'Space Mono'; font-size: 0.65rem; display: flex; align-items: center; justify-content: center; cursor: grab; z-index: 10; }
        .macro-overlap { background: var(--accent-3) !important; }

        /* ================= MOBILE UI OVERRIDES ================= */
        @media (max-width: 850px) {
            .module-container { padding: 15px 5% !important; }
            .hud-top { flex-direction: row !important; }
            .quiz-action-btns { flex-direction: row !important; gap: 10px !important; }
            .quiz-action-btns .btn { padding: 12px !important; font-size: 0.85rem !important; }
            .eco-stat-box { font-size: 0.75rem; min-width: 45%; }
            #macro-lib { flex-direction: row !important; flex-wrap: wrap !important; min-height: 170px !important; }
        }
    </style>
</head>
<body>

<div id="sim-loader"><div class="loader-terminal"><div id="loader-msg">> Initializing_Simulation...</div><div class="loader-bar-bg"><div class="loader-bar-fill" id="sim-progress"></div></div><div style="margin-top: 10px; font-size: 0.7rem; opacity: 0.6;" id="loader-submsg">Accessing Core...</div></div></div>
<div class="cursor-dot"></div><div class="cursor-outline"></div><canvas id="network" style="opacity: 0.4;"></canvas>

<nav id="navbar">
    <a href="index.html" class="logo-link" style="text-decoration: none;"><div><b>Pritesh Hirani <span class="emoji">üöÄ</span></b></div></a>
    <div>
        <a href="index.html#profile" class="nav-link"><span class="emoji">üë®‚Äçüíª</span> Profile</a>
        <a href="index.html#knowledge" class="nav-link"><span class="emoji">üß†</span> Knowledge Base</a>
        <a href="learn.html" class="nav-link"><span class="emoji">üìñ</span> Learn PD</a>
        <a href="games.html" class="nav-link active"><span class="emoji">üéÆ</span> Simulators</a>
        <a href="index.html#contact" class="nav-link"><span class="emoji">üì¨</span> Contact</a>
    </div>
</nav>

    <header class="games-header" id="games-title-header">
        <h1 class="section-title decode-text" data-value="System_Simulations">System_Simulations</h1>
    </header>

    <div class="game-grid" id="main-menu">
        <div class="card-wrapper"><div class="card" style="text-align: center;"><i class="fa-solid fa-brain" style="font-size: 3rem; color: var(--accent-1); margin-bottom: 20px;"></i><h3 style="margin-bottom:10px; font-family:'Space Mono'">Logic Quiz</h3><p style="color:var(--text-secondary); margin-bottom:20px; font-size: 0.85rem;">30s pressure test for VLSI concepts.</p><button class="btn magnetic" onclick="initQuiz()">Initialize</button></div></div>
        <div class="card-wrapper"><div class="card" style="text-align: center;"><i class="fa-solid fa-microchip" style="font-size: 3rem; color: var(--accent-2); margin-bottom: 20px;"></i><h3 style="margin-bottom:10px; font-family:'Space Mono'">Floorplan Master</h3><p style="color:var(--text-secondary); margin-bottom:20px; font-size: 0.85rem;">DRC-clean macro placement challenge.</p><button class="btn magnetic" onclick="initFloorplan()">Initialize</button></div></div>
        <div class="card-wrapper"><div class="card" style="text-align: center;"><i class="fa-solid fa-network-wired" style="font-size: 3rem; color: var(--accent-3); margin-bottom: 20px;"></i><h3 style="margin-bottom:10px; font-family:'Space Mono'">Nano Router</h3><p style="color:var(--text-secondary); margin-bottom:20px; font-size: 0.85rem;">Avoid congestion to route critical nets.</p><button class="btn magnetic" onclick="initRouter()">Initialize</button></div></div>
        <div class="card-wrapper"><div class="card" style="text-align: center;"><i class="fa-solid fa-stopwatch" style="font-size: 3rem; color: #f1c40f; margin-bottom: 20px;"></i><h3 style="margin-bottom:10px; font-family:'Space Mono'">Timing Closure</h3><p style="color:var(--text-secondary); margin-bottom:20px; font-size: 0.85rem;">Resolve Slack violations via ECO.</p><button class="btn magnetic" onclick="initECO()">Initialize</button></div></div>
        <div class="card-wrapper"><div class="card" style="text-align: center;"><i class="fa-solid fa-layer-group" style="font-size: 3rem; color: #9b59b6; margin-bottom: 20px;"></i><h3 style="margin-bottom:10px; font-family:'Space Mono'">Mask Matcher</h3><p style="color:var(--text-secondary); margin-bottom:20px; font-size: 0.85rem;">Decompose layout into Multi-Patterning masks.</p><button class="btn magnetic" onclick="initLitho()">Initialize</button></div></div>
    </div>

    <section id="quiz-module" class="module-container">
        <div class="quiz-hud">
            <div class="hud-top"><div class="quiz-timer-container"><svg class="timer-svg"><circle class="timer-circle-bg" cx="30" cy="30" r="28"></circle><circle class="timer-circle-prog" id="timer-bar" cx="30" cy="30" r="28"></circle></svg><div class="timer-text" id="timer-val">30</div></div><button class="stop-btn" onclick="terminateSession()">[ TERMINATE ]</button><div style="font-family: 'Space Mono'; color: var(--accent-1);" id="quiz-progress">Node: 1/4</div></div>
            <h2 id="question-text" style="margin-bottom:40px; color: #fff; font-size: 1.5rem;"></h2><div id="options-grid" class="options-grid"></div>
            <div class="quiz-action-btns"><button id="finish-early" class="btn magnetic" style="background: rgba(255, 0, 127, 0.1); border-color: var(--accent-3); color: var(--accent-3);" onclick="finishQuizEarly()">Submit Early</button><button id="next-q" class="btn magnetic" style="display:none;" onclick="nextQuestion()">Continue <i class="fa-solid fa-chevron-right"></i></button></div>
        </div>
    </section>

    <section id="floorplan-module" class="module-container">
        <div class="quiz-hud">
            <div class="hud-top"><div style="font-family: 'Space Mono'; color: var(--accent-3);">DRC_VIOLATIONS: <span id="ov-count" style="font-weight: bold;">0</span></div><button class="stop-btn" onclick="terminateSession()">[ ABORT ]</button></div>
            <div class="workspace-flex"><div id="chip-core"></div><div id="macro-side-panel"><div style="font-family:'Space Mono'; color:var(--accent-1); font-size: 0.8rem; border-bottom: 1px solid rgba(0,240,255,0.2); padding-bottom:10px; margin-bottom:15px; text-align:center;">MACRO_LIBRARY</div><div id="macro-lib" style="display:flex; flex-direction:row; flex-wrap:wrap; gap:10px; justify-content:center;"></div></div></div>
            <button class="btn" style="width:100%; margin-top:40px;" onclick="validateFP()">Run Signoff</button>
        </div>
    </section>

    <section id="router-module" class="module-container">
        <div class="quiz-hud">
            <div class="hud-top"><div style="font-family: 'Space Mono'; color: var(--accent-1);">TRACE_LENGTH: <span id="trace-len">0</span></div><button class="stop-btn" onclick="terminateSession()">[ ABORT ]</button></div>
            <div class="routing-workspace"><p style="color:var(--text-secondary); font-size:0.8rem; text-align:center; margin-bottom: 10px;">Tap squares to route from <span style="color:var(--accent-2); font-weight:bold;">S</span> to <span style="color:#2ecc71; font-weight:bold;">T</span>.</p><div id="routing-grid" class="routing-grid"></div></div>
            <div class="quiz-action-btns"><button class="btn magnetic" style="background: transparent; color: var(--text-secondary);" onclick="resetRouter()">Clear</button><button class="btn magnetic" style="background: rgba(0, 240, 255, 0.1); color: var(--accent-1);" onclick="initRouter()">New Net</button><button class="btn magnetic" onclick="validateRouter()">Verify</button></div>
        </div>
    </section>

    <section id="eco-module" class="module-container">
        <div class="quiz-hud">
            <div class="hud-top" style="flex-direction: column; gap: 15px; align-items: stretch; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between;"><div style="font-family: 'Space Mono'; font-weight: bold; color: white;">TIMING_REPORT</div><button class="stop-btn" onclick="terminateSession()">[ ABORT ]</button></div>
                <div class="eco-stats">
                    <div class="eco-stat-box" id="hud-setup">S: <span id="val-setup">0</span>ps</div><div class="eco-stat-box" id="hud-hold">H: <span id="val-hold">0</span>ps</div>
                    <div class="eco-stat-box" id="hud-area">A: <span id="val-area">0</span></div><div class="eco-stat-box" id="hud-leak">L: <span id="val-leak">0</span></div>
                </div>
            </div>
            <div class="eco-schematic" id="eco-schematic-view"></div>
            <div class="eco-inspector" id="eco-inspector">
                <div style="color: white; font-family: 'Space Mono'; font-weight: bold; margin-bottom: 10px;" id="insp-title">Select cell</div>
                <div class="insp-row"><span class="insp-label">VT:</span><div class="insp-btn-group"><button class="insp-btn" onclick="setVT('SVT')" id="btn-SVT">SVT</button><button class="insp-btn" onclick="setVT('LVT')" id="btn-LVT">LVT</button><button class="insp-btn" onclick="setVT('ELVT')" id="btn-ELVT">ELVT</button></div></div>
                <div class="insp-row"><span class="insp-label">Size:</span><div class="insp-btn-group"><button class="insp-btn" onclick="setSize(1)" id="btn-X1">X1</button><button class="insp-btn" onclick="setSize(2)" id="btn-X2">X2</button><button class="insp-btn" onclick="setSize(4)" id="btn-X4">X4</button></div></div>
            </div>
            <div class="quiz-action-btns"><button class="btn magnetic" style="background: rgba(0, 240, 255, 0.1);" onclick="initECO()">New Path</button><button class="btn magnetic" onclick="validateECO()">Signoff</button></div>
        </div>
    </section>

    <section id="litho-module" class="module-container">
        <div class="quiz-hud">
            <div class="hud-top">
                <div style="font-family: 'Space Mono'; color: white;">MASK_DECOMPOSITION</div>
                <button class="stop-btn" onclick="terminateSession()">[ ABORT ]</button>
            </div>
            <p style="color:var(--text-secondary); font-size:0.8rem; text-align:center;">TARGET LAYOUT (MATCH THIS)</p>
            <div id="litho-target" class="litho-grid" style="opacity: 0.5;"></div>
            <p style="color:var(--accent-1); font-size:0.8rem; text-align:center; margin-top:10px;">CURRENT WAFER EXPOSURE</p>
            <div id="litho-current" class="litho-grid"></div>
            <div class="litho-controls">
                <button class="litho-mask-btn" style="background:#e74c3c" onclick="toggleMask(0)"></button>
                <button class="litho-mask-btn" style="background:#3498db" onclick="toggleMask(1)"></button>
                <button class="litho-mask-btn" style="background:#f1c40f" onclick="toggleMask(2)"></button>
            </div>
            <div class="quiz-action-btns" style="margin-top:20px;">
                <button class="btn magnetic" style="background:rgba(0,240,255,0.1)" onclick="initLitho()">New Job</button>
                <button class="btn magnetic" onclick="validateLitho()">Expose Wafer</button>
            </div>
        </div>
    </section>

    <div class="mission-modal-overlay" id="missionModal">
        <div class="mission-modal">
            <div class="hud-corner c-tl"></div><div class="hud-corner c-tr"></div><div class="hud-corner c-bl"></div><div class="hud-corner c-br"></div>
            <div class="mission-icon" id="modalIcon"></div>
            <h2 class="decode-text" id="modalHeading" data-value="MISSION_COMPLETE">MISSION_COMPLETE</h2>
            <div class="mission-stats"><div class="stat-item"><span class="stat-label">STATUS</span><span class="stat-value" id="statusValue">--</span></div><div class="stat-item"><span class="stat-label">INTEGRITY</span><span class="stat-value" id="integrityValue">--</span></div></div>
            <p id="modalMessage" style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9rem; line-height: 1.6;"></p>
            <div class="modal-action-btns">
                <button class="btn magnetic" onclick="restartCurrentGame()" style="background: transparent; color: var(--text-secondary); border-color: var(--text-secondary);">Play Again</button>
                <button class="btn magnetic" onclick="location.reload()">Command Center</button>
            </div>
        </div>
    </div>

    <div class="mission-modal-overlay" id="terminateModal">
        <div class="mission-modal" style="border-color: var(--accent-3);">
            <div class="hud-corner c-tl" style="border-color: var(--accent-3);"></div><div class="hud-corner c-tr" style="border-color: var(--accent-3);"></div><div class="hud-corner c-bl" style="border-color: var(--accent-3);"></div><div class="hud-corner c-br" style="border-color: var(--accent-3);"></div>
            <div class="mission-icon" style="color: var(--accent-3);"><i class="fa-solid fa-radiation"></i></div>
            <h2 class="decode-text" id="termHeading" data-value="SYSTEM_OVERRIDE">SYSTEM_OVERRIDE</h2>
            <p style="color: var(--text-secondary); margin: 20px 0 30px; font-size: 0.9rem;">WARNING: Terminating simulation purges logic data. Proceed?</p>
            <div class="modal-action-btns">
                <button class="btn magnetic" onclick="closeTerminateModal()" style="background: transparent; border-color: var(--text-secondary); color: var(--text-secondary);">RESUME</button>
                <button class="btn magnetic" onclick="location.reload()" style="background: var(--accent-3); border-color: var(--accent-3); color: white;">TERMINATE</button>
            </div>
        </div>
    </div>

    <script src="script.js" defer></script>
    <script>
        // ================= SOUND ENGINE =================
        let activeGameModule = '';
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration, vol=0.1) { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime); gain.gain.setValueAtTime(vol, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + duration); }
        const sfx = { click:()=>playTone(800,'sine',0.05,0.03), correct:()=>{playTone(600,'square',0.1,0.05);setTimeout(()=>playTone(800,'square',0.15,0.05),100)}, wrong:()=>playTone(150,'sawtooth',0.3,0.1), pickup:()=>playTone(300,'sine',0.1,0.05), drop:()=>playTone(150,'sine',0.1,0.1), drcError:()=>playTone(200,'square',0.2,0.05), pass:()=>{playTone(440,'sine',0.3);playTone(554,'sine',0.3);playTone(659,'sine',0.5)}, fail:()=>{playTone(200,'sawtooth',0.5);playTone(180,'sawtooth',0.5)} };
        document.addEventListener('click', (e) => { if(e.target.tagName === 'BUTTON' || e.target.classList.contains('btn')) sfx.click(); });
        function enterImmersiveMode(moduleID) { if(audioCtx.state === 'suspended') audioCtx.resume(); document.getElementById('navbar').style.display = 'none'; document.getElementById('main-menu').style.display = 'none'; document.getElementById('games-title-header').style.display = 'none'; document.getElementById(moduleID).style.display = 'block'; }
        function showMissionDebrief(isSuccess, integrity, message) { const modal = document.getElementById('missionModal'); document.getElementById('statusValue').innerText = isSuccess ? "CLEARED" : "FAILED"; document.getElementById('statusValue').style.color = isSuccess ? "var(--accent-1)" : "var(--accent-3)"; document.getElementById('integrityValue').innerText = integrity; document.getElementById('modalMessage').innerText = message; const icon = document.getElementById('modalIcon'), heading = document.getElementById('modalHeading'); heading.setAttribute('data-value', isSuccess ? "MISSION_COMPLETE" : "MISSION_FAILED"); if (isSuccess) { icon.innerHTML = '<i class="fa-solid fa-circle-check"></i>'; icon.style.color = "var(--accent-1)"; modal.querySelector('.mission-modal').style.borderColor = "var(--accent-1)"; sfx.pass(); } else { icon.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i>'; icon.style.color = "var(--accent-3)"; modal.querySelector('.mission-modal').style.borderColor = "var(--accent-3)"; sfx.fail(); } modal.classList.add('active'); if(typeof decodeText === "function") decodeText(heading); }
        function restartCurrentGame() { document.getElementById('missionModal').classList.remove('active'); if(activeGameModule==='quiz') initQuiz(); else if(activeGameModule==='floorplan') initFloorplan(); else if(activeGameModule==='router') initRouter(); else if(activeGameModule==='eco') initECO(); else if(activeGameModule==='litho') initLitho(); }
        function terminateSession() { document.getElementById('terminateModal').classList.add('active'); if(typeof decodeText === "function") decodeText(document.getElementById('termHeading')); sfx.wrong(); }
        function closeTerminateModal() { document.getElementById('terminateModal').classList.remove('active'); }

        // ================= 1. QUIZ =================
        const quizData = [ { q: "Which violation occurs if data arrives at the captura flop too late?", a: "Setup Violation", o: ["Setup Violation", "Hold Violation", "DRC Error", "LVS Error"] }, { q: "What is the primary purpose of Decaps in Physical Design?", a: "Mitigate IR Drop", o: ["Fix Hold", "Mitigate IR Drop", "Reduce Area", "Increase Clock Speed"] } ];
        let qIndex=0, score=0, timer, timeLeft=30;
        function initQuiz() { activeGameModule='quiz'; enterImmersiveMode('quiz-module'); qIndex=0; score=0; loadQ(); }
        function loadQ() { timeLeft=30; document.getElementById('timer-val').innerText=timeLeft; clearInterval(timer); timer=setInterval(()=>{timeLeft--;document.getElementById('timer-val').innerText=timeLeft;document.getElementById('timer-bar').style.strokeDashoffset=176-(timeLeft/30)*176;if(timeLeft<=0){clearInterval(timer);checkA(null)}},1000); document.getElementById('question-text').innerText=quizData[qIndex].q; document.getElementById('quiz-progress').innerText=`Node: ${qIndex+1}/${quizData.length}`; const grid=document.getElementById('options-grid'); grid.innerHTML=''; [...quizData[qIndex].o].sort(()=>Math.random()-0.5).forEach(opt=>{const b=document.createElement('div');b.className='option-card';b.innerText=opt;b.onclick=()=>checkA(opt,b);grid.appendChild(b)}); document.getElementById('next-q').style.display='none'; }
        function checkA(opt, el) { clearInterval(timer); const correct=quizData[qIndex].a; if(opt===correct){score++;sfx.correct()}else{sfx.wrong()} document.querySelectorAll('.option-card').forEach(card=>{if(card.innerText===correct)card.classList.add('correct');card.style.pointerEvents='none'}); if(opt!==correct&&el)el.classList.add('wrong'); document.getElementById('next-q').style.display='block'; }
        function nextQuestion() { qIndex++; if(qIndex<quizData.length)loadQ(); else finishQuizEarly(); }
        function finishQuizEarly() { clearInterval(timer); const pct=Math.round((score/quizData.length)*100); showMissionDebrief(pct>=50, pct+"%", pct>=50?"Logic gates synchronized.":"Critical logic errors detected."); }

        // ================= 2. FLOORPLAN =================
        const macros = [ { n: "SRAM_A", w: 80, h: 110 }, { n: "CPU_CORE", w: 150, h: 150 } ];
        let activeM=null, offset={x:0, y:0};
        function initFloorplan() { activeGameModule='floorplan'; enterImmersiveMode('floorplan-module'); const lib=document.getElementById('macro-lib'); lib.innerHTML=''; macros.forEach(m=>{const d=document.createElement('div');d.className='macro';d.style.width=m.w+'px';d.style.height=m.h+'px';d.style.position='relative';d.innerText=m.n;d.onmousedown=startDrag;d.ontouchstart=startDrag;lib.appendChild(d)}); }
        function startDrag(e) { if(e.type==='touchstart') e.preventDefault(); activeM=e.target; sfx.pickup(); const r=activeM.getBoundingClientRect(); const cx=e.type.includes('touch')?e.touches[0].clientX:e.clientX, cy=e.type.includes('touch')?e.touches[0].clientY:e.clientY; offset={x:cx-r.left, y:cy-r.top}; if(activeM.parentElement.id==='macro-lib'){document.getElementById('chip-core').appendChild(activeM);activeM.style.position='absolute'} document.onmousemove=doDrag; document.onmouseup=stopDrag; document.ontouchmove=doDrag; document.ontouchend=stopDrag; }
        function doDrag(e) { if(!activeM) return; if(e.type==='touchmove') e.preventDefault(); const cx=e.type.includes('touch')?e.touches[0].clientX:e.clientX, cy=e.type.includes('touch')?e.touches[0].clientY:e.clientY; const core=document.getElementById('chip-core').getBoundingClientRect(); let x=cx-core.left-offset.x, y=cy-core.top-offset.y; x=Math.max(0,Math.min(x,core.width-activeM.offsetWidth)); y=Math.max(0,Math.min(y,core.height-activeM.offsetHeight)); activeM.style.left=x+'px'; activeM.style.top=y+'px'; checkDRC(); }
        function stopDrag() { activeM=null; document.onmousemove=null; document.onmouseup=null; document.ontouchmove=null; document.ontouchend=null; parseInt(document.getElementById('ov-count').innerText)>0?sfx.drcError():sfx.drop(); }
        function checkDRC() { const ms=document.querySelectorAll('#chip-core .macro'); let ov=0; ms.forEach(m=>m.classList.remove('macro-overlap')); for(let i=0; i<ms.length; i++){for(let j=i+1; j<ms.length; j++){const r1=ms[i].getBoundingClientRect(), r2=ms[j].getBoundingClientRect(); if(!(r1.right<r2.left||r1.left>r2.right||r1.bottom<r2.top||r1.top>r2.bottom)){ms[i].classList.add('macro-overlap');ms[j].classList.add('macro-overlap');ov++}}} document.getElementById('ov-count').innerText=ov; }
        function validateFP() { const ov=parseInt(document.getElementById('ov-count').innerText), placed=document.querySelectorAll('#chip-core .macro').length; if(placed<macros.length)showMissionDebrief(false,"0%","DRC ERROR: All macros must be placed."); else if(ov>0)showMissionDebrief(false,"40%","FAILED: Violations detected."); else showMissionDebrief(true,"100%","SUCCESS: GDSII Generated."); }

        // ================= 3. ROUTER =================
        let startNode=[0,0], endNode=[5,5], obstacles=[], routePath=[], isRouteComplete=false;
        function initRouter() { activeGameModule='router'; enterImmersiveMode('router-module'); startNode=[0,0]; endNode=[5,5]; obstacles=["1,1","2,2","3,3"]; resetRouter(); }
        function resetRouter() { routePath=[{x:startNode[0],y:startNode[1]}]; isRouteComplete=false; renderGrid(); }
        function renderGrid() { const grid=document.getElementById('routing-grid'); grid.innerHTML=''; for(let y=0; y<6; y++){for(let x=0; x<6; x++){const cell=document.createElement('div');cell.className='route-cell'; if(x===startNode[0]&&y===startNode[1]){cell.classList.add('start');cell.innerText='S'} else if(x===endNode[0]&&y===endNode[1]){cell.classList.add('end');cell.innerText='T'} else if(obstacles.includes(`${x},${y}`))cell.classList.add('obstacle'); const pi=routePath.findIndex(p=>p.x===x&&p.y===y); if(pi>0)cell.classList.add('path'); cell.onclick=()=>tapRoute(x,y); grid.appendChild(cell)}} document.getElementById('trace-len').innerText=routePath.length-1; }
        function tapRoute(x,y) { if(isRouteComplete)return; const ln=routePath[routePath.length-1]; if(Math.abs(x-ln.x)+Math.abs(y-ln.y)===1){if(obstacles.includes(`${x},${y}`)){sfx.drcError();return} routePath.push({x,y}); sfx.pickup(); if(x===endNode[0]&&y===endNode[1]){isRouteComplete=true;sfx.correct()} renderGrid(); } }
        function validateRouter() { if(isRouteComplete)showMissionDebrief(true,"100%","ROUTING SUCCESSFUL."); else showMissionDebrief(false,"OPEN","FAILED: Trace incomplete."); }

        // ================= 4. ECO =================
        const vtData={'SVT':{s:1.0,l:1.0},'LVT':{s:1.3,l:2.5},'ELVT':{s:2.0,l:10.0}};
        const szData={1:{s:1.0,a:1.0},2:{s:1.4,a:2.0},4:{s:1.8,a:4.0}};
        let reqT=0, reqH=0, maxA=0, maxL=0, cells=[], nets=[], selIdx=-1;
        function initECO() { activeGameModule='eco'; enterImmersiveMode('eco-module'); selIdx=-1; cells=[{id:"U1",type:"NAND2",baseDelay:30,basePwr:2,baseArea:2,vt:"SVT",size:1},{id:"U2",type:"NOR2",baseDelay:25,basePwr:2,baseArea:2,vt:"SVT",size:1}]; nets=[{buf:0},{buf:0},{buf:0}]; reqT=40; reqH=20; maxA=15; maxL=20; updateTiming(); }
        function updateTiming() { let td=0, ta=0, tl=0; cells.forEach(c=>{td+=c.baseDelay/(vtData[c.vt].s*szData[c.size].s);tl+=c.basePwr*szData[c.size].a*vtData[c.vt].l;ta+=c.baseArea*szData[c.size].a}); nets.forEach(n=>{td+=n.buf*15;ta+=n.buf*2;tl+=n.buf*1}); td=Math.round(td); ta=Math.round(ta); tl=Math.round(tl); document.getElementById('val-setup').innerText=reqT-td; document.getElementById('val-hold').innerText=td-reqH; document.getElementById('val-area').innerText=ta+"/"+maxA; document.getElementById('val-leak').innerText=tl+"/"+maxL; renderSchematic(); }
        function renderSchematic() { const v=document.getElementById('eco-schematic-view'); v.innerHTML='<div class="eco-flop">FF1</div>'; for(let i=0; i<cells.length; i++){ let bh=''; for(let b=0; b<nets[i].buf; b++) bh+='<div class="eco-buffer" onclick="remBuf(event,'+i+')"></div>'; v.innerHTML+='<div class="eco-node-wrapper"><div class="eco-wire" onclick="addBuf('+i+')">'+bh+'</div></div>'; const c=cells[i]; v.innerHTML+='<div class="eco-gate '+(i===selIdx?'active':'')+'" onclick="openInsp('+i+')"><div class="gate-title">'+c.id+'</div><div class="gate-specs"><span>X'+c.size+'</span><span class="spec-vt">'+c.vt+'</span></div></div>'; } let fbh=''; for(let b=0; b<nets[cells.length].buf; b++) fbh+='<div class="eco-buffer" onclick="remBuf(event,'+cells.length+')"></div>'; v.innerHTML+='<div class="eco-node-wrapper"><div class="eco-wire" onclick="addBuf('+cells.length+')">'+fbh+'</div></div><div class="eco-flop">FF2</div>'; }
        function addBuf(i){nets[i].buf++;sfx.pickup();updateTiming()}
        function remBuf(e,i){e.stopPropagation();if(nets[i].buf>0){nets[i].buf--;sfx.drop();updateTiming()}}
        function openInsp(i){selIdx=i;const c=cells[i];document.getElementById('eco-inspector').classList.add('visible');document.getElementById('insp-title').innerText='Edit '+c.id;updateTiming()}
        function setVT(vt){if(selIdx>-1){cells[selIdx].vt=vt;updateTiming()}}
        function setSize(s){if(selIdx>-1){cells[selIdx].size=s;updateTiming()}}
        function validateECO() { let s=parseInt(document.getElementById('val-setup').innerText), h=parseInt(document.getElementById('val-hold').innerText), a=parseInt(document.getElementById('val-area').innerText.split('/')[0]), l=parseInt(document.getElementById('val-leak').innerText.split('/')[0]); if(a>maxA||l>maxL)showMissionDebrief(false,"FAIL","Budget exceeded."); else if(s<0||h<0)showMissionDebrief(false,"FAIL","Timing violation."); else showMissionDebrief(true,"MET","Timing closed."); }

        // ================= 5. LITHO MASK MATCHER =================
        let targetMask=[0,0,1,1,0,1,0,1,0], currentMask=[0,0,0,0,0,0,0,0,0], masks=[[1,0,0,1,0,0,0,0,0],[0,0,1,0,0,1,0,0,0],[0,0,0,0,0,0,0,1,0]], activeMasks=[false,false,false];
        function initLitho() { activeGameModule='litho'; enterImmersiveMode('litho-module'); targetMask=[]; for(let i=0; i<9; i++) targetMask.push(Math.random()>0.5?1:0); activeMasks=[false,false,false]; renderLitho(); }
        function renderLitho() { const t=document.getElementById('litho-target'), c=document.getElementById('litho-current'); t.innerHTML=''; c.innerHTML=''; currentMask=new Array(9).fill(0); for(let i=0; i<3; i++){ if(activeMasks[i]){ for(let j=0; j<9; j++) if(masks[i][j]) currentMask[j]=1; } } for(let i=0; i<9; i++){ const tc=document.createElement('div');tc.className='litho-cell'+(targetMask[i]?' active':'');t.appendChild(tc); const cc=document.createElement('div');cc.className='litho-cell'+(currentMask[i]?' active':'');c.appendChild(cc); } const btns=document.querySelectorAll('.litho-mask-btn'); btns.forEach((b,i)=>b.classList.toggle('active',activeMasks[i])); }
        function toggleMask(i) { activeMasks[i]=!activeMasks[i]; sfx.pickup(); renderLitho(); }
        function validateLitho() { let match=true; for(let i=0; i<9; i++) if(targetMask[i]!==currentMask[i]) match=false; showMissionDebrief(match, match?"100%":"FAIL", match?"Pattern matched perfectly.":"Pattern mismatch detected."); }

    </script>
</body>
</html>
